<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>ã‚ã¿ã ãã˜ã§ãƒŠãƒ¼ã‚¹ãƒ¡ã‚¤ãƒ‰ã«ãŸã©ã‚Šç€ã‘â™¡</title>
<style>
  :root{ --bg:#fff7fb; --deep:#333; }
  html,body{height:100%;}
  body{ margin:0; padding:0; background:var(--bg); font-family:"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,system-ui,-apple-system,Segoe UI,Roboto,sans-serif; color:var(--deep); display:flex; align-items:center; justify-content:center; -webkit-user-select:none; user-select:none; touch-action:manipulation; }
  .frame{ width:min(94vw,430px); position:relative; background:linear-gradient(180deg,#fff 0%,#fff0fa 100%); border:4px solid #ffd2ea; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.08); overflow:hidden; }
  /* JS ç”Ÿå­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ */
  .lamp{ position:absolute; right:8px; top:8px; z-index:1000; font:12px/1.2 system-ui; background:#fff; border:1px solid #ddd; border-radius:10px; padding:4px 8px; }
  .ok{ color:#0a7; font-weight:700; } .ng{ color:#b00; font-weight:700; }
  .brand{ position:absolute; left:8px; top:8px; font-size:12px; color:#777; z-index:1000;}
  header{ text-align:center; padding:28px 8px 6px; position:relative; z-index:900; }
  .tag{ display:inline-block; padding:4px 10px; font-size:12px; border-radius:999px; background:#ffe6f3; color:#cc3b88; border:1px solid #ffb7db; }
  h1{ margin:6px 10px 0; font-size:clamp(16px,4.5vw,20px); line-height:1.3; font-weight:800; }
  .sub{font-size:12px; color:#666;}

  .topChoices{ position:absolute; left:0; right:0; top:88px; display:flex; justify-content:center; gap:8px; z-index:900; }
  .choiceBtn{ min-width:44px; padding:6px 10px; font-weight:700; font-size:14px; border-radius:999px; background:linear-gradient(180deg,#ffb9db,#ff89c3); color:#fff; border:none; box-shadow:0 3px 0 #d45095; position:relative; }
  .choiceBtn[disabled]{ opacity:.6; filter:grayscale(.2); }
  .pressable{ position:relative; overflow:hidden; transition: transform .06s ease, box-shadow .06s ease; -webkit-tap-highlight-color: transparent; }
  .pressable.pressed{ transform: translateY(2px) scale(0.98); box-shadow:0 1px 0 rgba(0,0,0,.12) !important; filter: saturate(1.05); }
  .pressable .ripple{ position:absolute; pointer-events:none; border-radius:999px; transform:scale(0); opacity:0.35; background:#ffffff; mix-blend-mode:overlay; animation:ripple .45s ease-out; }
  @keyframes ripple{ to{ transform:scale(6); opacity:0; } }

  .canvasWrap{ position:absolute; top:120px; left:10px; right:10px; bottom:90px; border-radius:16px; background:#fff; border:2px dashed #ffd2ea; overflow:hidden; z-index:100; }
  canvas{ display:block; width:100%; height:100%; }

  .overlay{ position:absolute; top:120px; left:10px; right:10px; bottom:90px; display:flex; align-items:center; justify-content:center; pointer-events:none !important; opacity:0; transition:opacity .35s ease; z-index:400; }
  .overlay.show{ opacity:1; }
  .resultCard{ background:#fff; border:3px solid #ffd2ea; border-radius:18px; padding:18px 16px; text-align:center; width:min(88%,340px); box-shadow:0 20px 40px rgba(255,71,165,.18); }
  .resultCard h2{ margin:0 0 8px; font-size:22px; }
  .resultCard p{ margin:0; font-size:14px; color:#555; }
  .badge{ display:inline-block; padding:4px 10px; border-radius:999px; font-weight:800; margin-bottom:8px; }
  .badge.win{ background:#ffe3f3; color:#c1006c; border:1px solid #ffb6de; }
  .badge.lose{ background:#eef6ff; color:#1b4aa0; border:1px solid #c6e0ff; }

  .fxLayer{ position:absolute; top:120px; left:10px; right:10px; bottom:90px; pointer-events:none !important; z-index:300; overflow:visible; }
  .heart{ position:absolute; left:50%; top:0; width:12px; height:12px; transform:translate(-50%,-50%) rotate(45deg); background:#ff7eb6; border-radius:2px; opacity:0; animation:fallHeart 1.4s ease-in forwards; }
  .heart::before,.heart::after{ content:""; position:absolute; width:12px; height:12px; border-radius:50%; background:inherit; }
  .heart::before{ left:0; top:-6px; } .heart::after{ left:-6px; top:0; }
  @keyframes fallHeart{ 0%{opacity:0; transform:translate(-50%,-10%) rotate(45deg) scale(.6);} 10%{opacity:1;} 100%{opacity:0; transform:translate(-50%,110%) rotate(45deg) scale(1);} }
  .glowBurst{ position:absolute; width:60px; height:60px; border-radius:50%; box-shadow:0 0 20px 8px rgba(255,136,200,.7), 0 0 40px 14px rgba(255,136,200,.35); opacity:0; transform:translate(-50%,-50%) scale(.6); animation:glowPop .8s ease-out forwards; }
  @keyframes glowPop{ to{ opacity:0; transform:translate(-50%,-50%) scale(1.6);} }
  .smoke{ position:absolute; width:14px; height:14px; border-radius:50%; background:radial-gradient(circle, rgba(255,255,255,.9) 0%, rgba(233,233,233,.6) 50%, rgba(200,200,200,.0) 70%); filter:blur(1px); opacity:0; transform:translate(-50%,-50%) scale(.6); animation:puff .7s ease-out forwards; }
  @keyframes puff{ 0%{ opacity:0; transform:translate(-50%,-30%) scale(.4); } 15%{ opacity:.9; } 100%{ opacity:0; transform:translate(-50%,-110%) scale(1.6); } }

  footer.controls{ position:absolute; left:0; right:0; bottom:6px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap; padding:6px 10px; z-index:900; }
  .btn{ padding:10px 14px; border-radius:12px; border:none; font-weight:800; font-size:14px; box-shadow:0 4px 0 rgba(0,0,0,.08); }
  .primary{ background:linear-gradient(180deg,#a1e7f3,#6ad0e7); color:#0b4c5a; box-shadow:0 4px 0 #3a9fb1; }
  .ghost{ background:#fff; color:#555; border:1px solid #ddd; }
</style>
</head>
<body>
  <div class="frame" id="frame" role="application" aria-label="ãƒŠãƒ¼ã‚¹ã«ãŸã©ã‚Šç€ã‘ï¼ã‚ã¿ã ãã˜ã‚²ãƒ¼ãƒ ">
    <div class="brand">concept cafe <b>POãƒ»TORO</b></div>
    <div class="lamp" id="lamp">JS: <span class="ng" id="lampState">NG</span></div>

    <header>
      <span class="tag">ğŸ©º ãƒãƒ»ãƒˆãƒ­ã‚¯ãƒªãƒ‹ãƒƒã‚¯</span>
      <h1>ãƒŠãƒ¼ã‚¹ãƒ¡ã‚¤ãƒ‰ã«ãŸã©ã‚Šç€ã‘ï¼ãƒãƒˆãƒ­ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã§ã‚ã¿ã ãã˜â™¡</h1>
      <div class="sub">æ‚£è€…ã”ä¸»äººæ§˜ã¯ã€é‹å‘½ã®ãƒŠãƒ¼ã‚¹ã•ã‚“ã«å‡ºä¼šãˆã‚‹ã‹â€¦ï¼Ÿ</div>
    </header>

    <div class="topChoices" id="choiceRow"></div>
    <div class="canvasWrap"><canvas id="amida"></canvas></div>
    <div class="overlay" id="resultOverlay" aria-live="polite"></div>
    <div class="fxLayer" id="fxLayer"></div>

    <footer class="controls">
      <button class="btn primary pressable" id="startBtn">è¨ºå¯Ÿé–‹å§‹â™¡</button>
      <button class="btn ghost pressable" id="muteBtn" aria-pressed="false">ğŸ”Š ã‚µã‚¦ãƒ³ãƒ‰</button>
    </footer>
  </div>

<script>
(function(){
  'use strict';
  // ï¼ï¼ï¼ï¼ï¼ ç”Ÿå­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ ï¼ï¼ï¼ï¼ï¼
  function lampOK(){ try{ document.getElementById('lampState').textContent='OK'; document.getElementById('lampState').className='ok'; }catch(e){} }
  function lampNG(msg){ try{ document.getElementById('lampState').textContent='NG'; document.getElementById('lampState').className='ng'; if(msg){ console.log('[BOOT ERROR]', msg); } }catch(e){} }
  window.addEventListener('error', function(e){ lampNG(e && (e.message || 'error')); });

  // ï¼ï¼ï¼ï¼ï¼ Audio ï¼ï¼ï¼ï¼ï¼
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const audio = { ctx:null, master:null, muted:false, bgm:null, bgmGain:null };
  function setupAudio(){ if(audio.ctx) return; try{ audio.ctx=new AudioCtx(); audio.master=audio.ctx.createGain(); audio.master.gain.value=0.8; audio.master.connect(audio.ctx.destination);}catch(e){} }
  function resumeAudio(){ try{ if(audio.ctx && audio.ctx.state==='suspended' && audio.ctx.resume){ audio.ctx.resume(); } }catch(e){} }

  // ï¼ï¼ï¼ï¼ï¼ åŸºæœ¬å®šæ•°/çŠ¶æ…‹ ï¼ï¼ï¼ï¼ï¼
  const COLS = 5, BAR_COUNT=18, SPEED_Y=2.2, SPEED_X=3.0, REVEAL_BUFFER=28;
  const canvas=document.getElementById('amida'), ctx=canvas.getContext('2d');
  let W=360,H=560, topMargin=24,bottomMargin=36,leftMargin=28,rightMargin=28;
  let colX=[], bars=[], goals=[], chosenIndex=null, running=false, revealY=0, player=null, animId=null;

  // ï¼ï¼ï¼ï¼ï¼ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ï¼ï¼ï¼ï¼ï¼
  function fixFrameHeight(){ const frame=document.getElementById('frame'); const w=frame.clientWidth||360; frame.style.height=Math.round(w*16/9)+'px'; }
  function computeCols(){ colX=[]; const innerW=W-leftMargin-rightMargin; for(let i=0;i<COLS;i++){ colX.push(leftMargin + innerW*(i/(COLS-1))); } }
  function drawBackdrop(){ ctx.save(); const r=(window.devicePixelRatio||1); for(let y=topMargin; y<H-bottomMargin; y+=40*r){ for(let x=leftMargin; x<W-rightMargin; x+=40*r){ ctx.globalAlpha=0.05; ctx.fillStyle='#ff7eb6'; drawHeart(x,y,6*r); ctx.fillStyle='#79d1e3'; drawPlus(x+14*r,y+12*r,6*r);} } ctx.restore(); }
  function resize(){ const wrap=document.querySelector('.canvasWrap'); const rect=wrap.getBoundingClientRect(); const ratio=window.devicePixelRatio||1; W=Math.floor(rect.width*ratio); H=Math.floor(rect.height*ratio); canvas.width=W; canvas.height=H; canvas.style.width=rect.width+'px'; canvas.style.height=rect.height+'px'; topMargin=Math.round(24*ratio); bottomMargin=Math.round(36*ratio); leftMargin=Math.round(28*ratio); rightMargin=Math.round(28*ratio); computeCols(); draw(); }

  // ï¼ï¼ï¼ï¼ï¼ ã‚²ãƒ¼ãƒ ç”Ÿæˆ ï¼ï¼ï¼ï¼ï¼
  function genBars(){ const minGap=18*(window.devicePixelRatio||1), ys=[]; const usableTop=topMargin+12, usableBottom=H-bottomMargin-12;
    while(ys.length<BAR_COUNT){ const y=Math.round(usableTop+Math.random()*(usableBottom-usableTop)); if(ys.every(v=>Math.abs(v-y)>minGap)) ys.push(y); }
    ys.sort((a,b)=>a-b); bars=[]; for(const y of ys){ const from=Math.floor(Math.random()*(COLS-1)); const tooClose=bars.some(b=>Math.abs(b.y-y)<minGap && Math.abs(b.from-from)<1); if(!tooClose) bars.push({y,from}); }
  }
  function genGoals(){ goals=new Array(COLS); for(let i=0;i<COLS;i++) goals[i]='lose'; let winIndex=Math.floor(Math.random()*COLS); if(!(winIndex>=0 && winIndex<COLS)) winIndex=0; goals[winIndex]='win'; }

  // ï¼ï¼ï¼ï¼ï¼ é€²è¡Œ ï¼ï¼ï¼ï¼ï¼
  function line(x1,y1,x2,y2){ ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); }
  function drawHeart(cx,cy,s){ ctx.beginPath(); for(let a=0;a<=Math.PI*2;a+=0.1){ const x=s*16*Math.pow(Math.sin(a),3)/16; const y=-s*(13*Math.cos(a)-5*Math.cos(2*a)-2*Math.cos(3*a)-Math.cos(4*a))/16; if(a===0) ctx.moveTo(cx+x,cy+y); else ctx.lineTo(cx+x,cy+y);} ctx.closePath(); ctx.fill(); }
  function drawPlus(cx,cy,s){ ctx.save(); ctx.translate(cx,cy); ctx.beginPath(); ctx.rect(-s/2,-s*1.6,s,s*3.2); ctx.rect(-s*1.6,-s/2,s*3.2,s); ctx.fill(); ctx.restore(); }
  function drawPatient(x,y){ ctx.save(); ctx.translate(x,y); const r=10*(window.devicePixelRatio||1); ctx.fillStyle='#ffe9c9'; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#f0f0f0'; ctx.strokeStyle='#cfcfcf'; ctx.lineWidth=1*(window.devicePixelRatio||1); ctx.beginPath(); ctx.moveTo(-r,-4); ctx.lineTo(r,-1); ctx.lineTo(r,3); ctx.lineTo(-r,0); ctx.closePath(); ctx.fill(); ctx.stroke(); ctx.fillStyle='#333'; ctx.beginPath(); ctx.arc(-4,0,1.2*(window.devicePixelRatio||1),0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(4,0,1.2*(window.devicePixelRatio||1),0,Math.PI*2); ctx.fill(); ctx.fillStyle='#c0e9f5'; ctx.beginPath(); ctx.moveTo(-6,r); ctx.lineTo(6,r); ctx.lineTo(0,r+10); ctx.closePath(); ctx.fill(); ctx.restore(); }
  function drawNurse(x,y,scale=1){ const r=9*(window.devicePixelRatio||1)*scale; ctx.save(); ctx.translate(x,y); ctx.fillStyle='#ffe9f1'; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#ffffff'; ctx.beginPath(); ctx.ellipse(0,-r*0.9,r*0.9,r*0.55,0,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#ff78b4'; drawPlus(0,-r*0.9,6*(window.devicePixelRatio||1)*scale); ctx.fillStyle='#333'; ctx.beginPath(); ctx.arc(-3,-1,1.1*(window.devicePixelRatio||1)*scale,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(3,-1,1.1*(window.devicePixelRatio||1)*scale,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#ff4fae'; ctx.lineWidth=1.3*(window.devicePixelRatio||1)*scale; ctx.beginPath(); ctx.arc(0,3,3*scale,0,Math.PI); ctx.stroke(); ctx.restore(); }
  function drawBandAidCross(x,y,scale=1){ const dpr=(window.devicePixelRatio||1), s=dpr*scale; ctx.save(); ctx.translate(x,y); ctx.rotate(Math.PI/4); const w=36*s,h=10*s,r=5*s;
    ctx.save(); ctx.rotate(-Math.PI/4); ctx.fillStyle='rgba(0,0,0,0.06)'; ctx.beginPath(); ctx.ellipse(0,(w/2+h/2)*0.4,(w*0.55),3*s,0,0,Math.PI*2); ctx.fill(); ctx.restore();
    const base='#ffe0b3', edge='#e6be86', hole='#f3c992';
    function roundRectCenter(cx,cy,w,h,r){ const x=cx-w/2, y=cy-h/2; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r); ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h); ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r); ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath(); }
    function drawPill(cx,cy,w,h,r, fill, stroke){ ctx.fillStyle=fill; ctx.strokeStyle=stroke; ctx.lineWidth=1.5*s; roundRectCenter(cx,cy,w,h,r); ctx.fill(); ctx.stroke(); const pw=w*0.36, ph=h*0.7, pr=3*s; ctx.fillStyle='#fff4e2'; ctx.strokeStyle='#f2d7ad'; ctx.lineWidth=1*s; roundRectCenter(cx,cy,pw,ph,pr); ctx.fill(); ctx.stroke(); }
    function drawHoles(cx,cy,w,h,color){ ctx.fillStyle=color; const gx=w*0.22, gy=h*0.26, rDot=0.9*s; for(let j=-1;j<=1;j+=2){ for(let i=-1.5;i<=1.5;i+=1){ const px=cx+i*gx, py=cy+j*gy; ctx.beginPath(); ctx.arc(px,py,rDot,0,Math.PI*2); ctx.fill(); } } }
    drawPill(0,0,w,h,r,base,edge); drawHoles(0,0,w,h,hole); ctx.save(); ctx.rotate(Math.PI/2); drawPill(0,0,w,h,r,base,edge); drawHoles(0,0,w,h,hole); ctx.restore(); ctx.restore();
  }

  function draw(){
    ctx.clearRect(0,0,W,H);
    drawBackdrop();
    ctx.lineWidth=3*(window.devicePixelRatio||1);
    ctx.strokeStyle='#ffb6de';
    for(let i=0;i<COLS;i++){ line(colX[i],topMargin,colX[i],H-bottomMargin); }
    ctx.strokeStyle='#79d1e3';
    for(const b of bars){ if(b.y<=revealY){ line(colX[b.from],b.y,colX[b.from+1],b.y); } }
    if(player){ drawPatient(player.x,player.y); }
    ctx.fillStyle='#ffffff'; ctx.globalAlpha=1.0; ctx.fillRect(0,revealY,W,H-revealY);
    const g=ctx.createLinearGradient(0,revealY-14,0,revealY+2); g.addColorStop(0,'rgba(255,255,255,0)'); g.addColorStop(1,'rgba(255,255,255,1)'); ctx.fillStyle=g; ctx.fillRect(0,revealY-14,W,16);
    if(revealY>H-bottomMargin-26){ for(let i=0;i<COLS;i++){ const cx=colX[i]; const ty=H-bottomMargin+8; if(goals[i]==='win') drawNurse(cx,ty,0.85); else drawBandAidCross(cx,ty,0.9); } }
  }

  function confettiHeartsFrontLayer(count=18){ const fx=document.getElementById('fxLayer'); const colors=['#ff7eb6','#79d1e3','#ffd166','#95d47a']; const width=fx.clientWidth; for(let i=0;i<count;i++){ const h=document.createElement('div'); h.className='heart'; h.style.left=(Math.random()*width)+'px'; h.style.animationDuration=(1100+Math.random()*700)+'ms'; h.style.background=colors[i%colors.length]; fx.appendChild(h); h.addEventListener('animationend', ()=>h.remove()); } }
  function showGlowAtColumn(col){ const fx=document.getElementById('fxLayer'); const cv=canvas.getBoundingClientRect(); const fxr=fx.getBoundingClientRect(); const dpr=window.devicePixelRatio||1; const x=colX[col]/dpr + (cv.left - fxr.left); const y=(H-(bottomMargin)+8)/dpr + (cv.top - fxr.top); const el=document.createElement('div'); el.className='glowBurst'; el.style.left=x+'px'; el.style.top=y+'px'; fx.appendChild(el); setTimeout(()=>el.remove(),900); }
  function smokePuffAtColumn(col,count=14){ const fx=document.getElementById('fxLayer'); const cv=canvas.getBoundingClientRect(); const fxr=fx.getBoundingClientRect(); const dpr=window.devicePixelRatio||1; const baseX=colX[col]/dpr + (cv.left - fxr.left); const baseY=(H-(bottomMargin)+8)/dpr + (cv.top - fxr.top); for(let i=0;i<count;i++){ const s=document.createElement('div'); s.className='smoke'; s.style.left=(baseX + (Math.random()*24-12))+'px'; s.style.top=(baseY + (Math.random()*8-4))+'px'; s.style.animationDuration=(600+Math.random()*300)+'ms'; fx.appendChild(s); s.addEventListener('animationend',()=>s.remove()); } }
  function animateNurseToPatient(col,duration=650){ const start=performance.now(); const x=colX[col], y=H-bottomMargin+8; function step(now){ const t=Math.min(1,(now-start)/duration); draw(); ctx.save(); const s=0.85*(1+0.03*Math.sin(t*10)); ctx.globalAlpha=1-t; drawNurse(x,y,s); ctx.globalAlpha=t; drawPatient(x,y); ctx.globalAlpha=1; ctx.restore(); if(t<1) requestAnimationFrame(step); } requestAnimationFrame(step); }

  function playBGM(){ if(audio.muted) return; setupAudio(); resumeAudio(); stopBGM(); if(!audio.ctx) return; const c=audio.ctx; const tempo=108, beat=60/tempo; audio.bgmGain=c.createGain(); audio.bgmGain.gain.value=0.06; audio.bgmGain.connect(audio.master); const notes=[262,330,392,523]; const start=c.currentTime+0.05; const length=8; audio.bgm={timers:[]}; function loop(){ for(let i=0;i<64;i++){ const n=notes[i%notes.length]; const when=start+i*beat*0.5; const o=c.createOscillator(); const g=c.createGain(); o.type='triangle'; o.frequency.value=n; g.gain.setValueAtTime(0,when); g.gain.linearRampToValueAtTime(0.15,when+0.01); g.gain.exponentialRampToValueAtTime(0.0001,when+beat*0.45); o.connect(g).connect(audio.bgmGain); try{ o.start(when); o.stop(when+beat*0.5);}catch(e){} audio.bgm.timers.push(o);} audio.bgm.loopTimer=setTimeout(loop,length*1000);} loop(); }
  function stopBGM(){ if(audio.bgm){ if(audio.bgm.loopTimer) clearTimeout(audio.bgm.loopTimer); if(audio.bgm.timers){ audio.bgm.timers.forEach(o=>{try{o.stop();}catch(e){}});} } if(audio.bgmGain){ try{audio.bgmGain.disconnect();}catch(e){} audio.bgmGain=null; } audio.bgm=null; }
  function sePop(){ if(audio.muted) return; setupAudio(); resumeAudio(); if(!audio.ctx) return; const c=audio.ctx,o=c.createOscillator(),g=c.createGain(); o.type='triangle'; o.frequency.value=500; g.gain.setValueAtTime(0,c.currentTime); g.gain.linearRampToValueAtTime(0.2,c.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001,c.currentTime+0.18); o.connect(g).connect(audio.master); try{ o.start(); o.stop(c.currentTime+0.2);}catch(e){} }
  function seFanfare(){ if(audio.muted) return; setupAudio(); resumeAudio(); if(!audio.ctx) return; const c=audio.ctx; const now=c.currentTime+0.03; const seq=[261.6,329.6,392.0,523.3]; seq.forEach((f,i)=>{ const o=c.createOscillator(), g=c.createGain(); o.type='sine'; o.frequency.value=f; const t=now+i*0.18; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.3,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.35); o.connect(g).connect(audio.master); try{ o.start(t); o.stop(t+0.4);}catch(e){} }); }
  function seChime(win){ if(audio.muted) return; setupAudio(); resumeAudio(); if(!audio.ctx) return; const c=audio.ctx, base=win?880:220, now=c.currentTime+0.02; for(let i=0;i<3;i++){ const o=c.createOscillator(), g=c.createGain(); o.type=win?'sine':'square'; try{ o.frequency.setValueAtTime(base*(i+1), now+i*0.09);}catch(e){ o.frequency.value=base*(i+1);} g.gain.setValueAtTime(0, now+i*0.09); g.gain.linearRampToValueAtTime(0.25, now+i*0.09+0.01); g.gain.exponentialRampToValueAtTime(0.0001, now+i*0.09+0.25); o.connect(g).connect(audio.master); try{ o.start(now); o.stop(now+0.5);}catch(e){} } }

  function drawScene(){ ctx.lineWidth=3*(window.devicePixelRatio||1); }

  function buildChoiceButtons(){
    const row=document.getElementById('choiceRow'); row.innerHTML='';
    for(let i=0;i<COLS;i++){
      const b=document.createElement('button');
      b.className='choiceBtn pressable'; b.id='choice'+i;
      b.textContent='è¨ºå¯Ÿ'+(i+1);
      // iOSã¯ touchstart ã‚’ä¸»ã«
      b.addEventListener('touchstart', ()=>{ choose(i); }, {passive:true});
      b.addEventListener('click', ()=>{ choose(i); });
      row.appendChild(b);
    }
  }

  function choose(idx){
    if(running) return;
    chosenIndex=idx;
    player={ x:colX[idx], y:topMargin, col:idx, phase:'down', targetX:colX[idx] };
    revealY=topMargin+REVEAL_BUFFER;
    running=true; animate();
    document.querySelectorAll('.choiceBtn').forEach(b=>b.disabled=true);
    const sb=document.getElementById('startBtn'); if(sb) sb.disabled=true;
    if(!audio.muted){ playBGM(); } sePop();
  }

  function draw(){
    ctx.clearRect(0,0,W,H);
    drawBackdrop();
    ctx.lineWidth=3*(window.devicePixelRatio||1);
    ctx.strokeStyle='#ffb6de';
    for(let i=0;i<COLS;i++){ line(colX[i],topMargin,colX[i],H-bottomMargin); }
    ctx.strokeStyle='#79d1e3';
    for(const b of bars){ if(b.y<=revealY){ line(colX[b.from],b.y,colX[b.from+1],b.y); } }
    if(player){ drawPatient(player.x,player.y); }
    ctx.fillStyle='#ffffff'; ctx.globalAlpha=1.0; ctx.fillRect(0,revealY,W,H-revealY);
    const g=ctx.createLinearGradient(0,revealY-14,0,revealY+2); g.addColorStop(0,'rgba(255,255,255,0)'); g.addColorStop(1,'rgba(255,255,255,1)'); ctx.fillStyle=g; ctx.fillRect(0,revealY-14,W,16);
    if(revealY>H-bottomMargin-26){ for(let i=0;i<COLS;i++){ const cx=colX[i]; const ty=H-bottomMargin+8; if(goals[i]==='win') drawNurse(cx,ty,0.85); else drawBandAidCross(cx,ty,0.9); } }
  }

  function advancePlayer(){
    if(!player) return;
    const EPS=0.5*(window.devicePixelRatio||1);
    if(player.phase==='down'){
      const nextBar=bars.filter(b=> b.y>player.y+EPS && (b.from===player.col-1 || b.from===player.col)).sort((a,b)=>a.y-b.y)[0];
      const nextY= nextBar? nextBar.y : (H-bottomMargin);
      const dy=Math.max(0, Math.min(SPEED_Y, nextY-player.y));
      player.y+=dy; revealY=Math.min(player.y+REVEAL_BUFFER, H-bottomMargin+12);
      if(nextBar && Math.abs(player.y-nextY)<=EPS){
        if(nextBar.from===player.col){ player.phase='right'; player.targetX=colX[player.col+1]; }
        else { player.phase='left'; player.targetX=colX[player.col-1]; }
      }
      if(player.y>=H-bottomMargin-EPS){ running=false; endResult(goals[player.col]==='win'); }
    } else {
      const dir=(player.phase==='right')?1:-1;
      const vx=dir*SPEED_X, nx=player.x+vx;
      if((dir>0 && nx>=player.targetX) || (dir<0 && nx<=player.targetX)){ player.x=player.targetX; player.col+=dir; player.phase='down'; player.y+=EPS; }
      else { player.x=nx; }
    }
  }

  function stopAnim(){ if(animId) cancelAnimationFrame(animId); animId=null; }
  function animate(){ stopAnim(); const step=()=>{ if(!running){ draw(); return; } advancePlayer(); draw(); animId=requestAnimationFrame(step); }; animId=requestAnimationFrame(step); }

  function endResult(isVisibleWin){
    stopBGM();
    let isTrueWin=false; if(isVisibleWin){ isTrueWin = Math.random() < (1/3); }
    const overlay=document.getElementById('resultOverlay');
    function show(kind){
      let badge,title,note;
      if(kind==='win'){ badge='<span class="badge win">å¤§å½“ãŸã‚ŠğŸ’–</span>'; title='ãƒŠãƒ¼ã‚¹ã•ã‚“ã«è¨ºã¦ã‚‚ã‚‰ãˆãŸâ™¡'; note='æœ¬æ—¥ã®ã”ä¸»äººæ§˜ã¯è¶…ãƒ©ãƒƒã‚­ãƒ¼ï¼å—ä»˜ã§ç”»é¢ã‚’è¦‹ã›ã¦ã­â™ª'; }
      else if(kind==='fake'){ badge='<span class="badge lose">å½ãƒŠãƒ¼ã‚¹ã ã£ãŸâ€¦ğŸ’Š</span>'; title='æ®‹å¿µâ€¦'; note='å†è¨ºäºˆç´„ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚'; }
      else { badge='<span class="badge lose">è¨ºå¯Ÿä¸­â€¦ğŸ’Š</span>'; title='æ®‹å¿µâ€¦è¨ºå¯Ÿå»¶æœŸã§ã™â€¦'; note='å†è¨ºäºˆç´„ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚'; }
      overlay.innerHTML='<div class="resultCard">'+badge+'<h2>'+title+'</h2><p>'+note+'</p></div>'; overlay.classList.add('show');
      const sb=document.getElementById('startBtn'); if(sb) sb.disabled=false;
    }
    if(isTrueWin){ seFanfare(); showGlowAtColumn(player.col); confettiHeartsFrontLayer(20); setTimeout(()=>show('win'),350); }
    else if(isVisibleWin){ sePop(); animateNurseToPatient(player.col,650); smokePuffAtColumn(player.col,14); setTimeout(()=>show('fake'),700); }
    else { seChime(false); show('lose'); }
  }

  // ï¼ï¼ï¼ï¼ï¼ ãƒœã‚¿ãƒ³ ï¼ï¼ï¼ï¼ï¼
  function setupPressable(){
    const addRipple=(btn,x,y)=>{ const r=document.createElement('span'); r.className='ripple'; const rect=btn.getBoundingClientRect(); const d=Math.max(rect.width,rect.height); r.style.width=r.style.height=d+'px'; r.style.left=(x-rect.left-d/2)+'px'; r.style.top=(y-rect.top-d/2)+'px'; btn.appendChild(r); r.addEventListener('animationend', ()=>r.remove()); };
    const press=(e)=>{ const btn=e.currentTarget; btn.classList.add('pressed'); const t=e.touches && e.touches[0]; const px=t? t.clientX : (e.clientX || (btn.getBoundingClientRect().left + btn.offsetWidth/2)); const py=t? t.clientY : (e.clientY || (btn.getBoundingClientRect().top + btn.offsetHeight/2)); addRipple(btn,px,py); };
    const release=(e)=>{ e.currentTarget.classList.remove('pressed'); };
    document.querySelectorAll('.pressable').forEach(btn=>{
      btn.addEventListener('touchstart', press, {passive:true});
      btn.addEventListener('touchend', release, {passive:true});
      btn.addEventListener('click', release);
    });
  }

  function resetGame(){
    chosenIndex=null; running=false; revealY=topMargin;
    genBars(); genGoals(); buildChoiceButtons(); setupPressable();
    stopAnim(); player=null;
    const ov=document.getElementById('resultOverlay'); ov.innerHTML=''; ov.classList.remove('show');
    draw();
  }

  // ï¼ï¼ï¼ï¼ï¼ èµ·å‹•ï¼ˆå¤šæ®µãƒªãƒˆãƒ©ã‚¤ï¼‰ ï¼ï¼ï¼ï¼ï¼
  function mount(){
    let tries=0;
    const boot=()=>{
      tries++;
      fixFrameHeight();
      const w=document.getElementById('frame').clientWidth||0;
      if(w<10 && tries<30){ return requestAnimationFrame(boot); }
      try{
        resize(); genBars(); genGoals(); buildChoiceButtons(); setupPressable(); draw();
        const sb=document.getElementById('startBtn');
        const mb=document.getElementById('muteBtn');
        sb.addEventListener('touchstart', ()=>{ resetGame(); setupAudio(); resumeAudio(); if(!audio.muted){ playBGM(); } }, {passive:true});
        sb.addEventListener('click', ()=>{ resetGame(); setupAudio(); resumeAudio(); if(!audio.muted){ playBGM(); } });
        mb.addEventListener('touchstart', ()=>{ audio.muted=!audio.muted; mb.setAttribute('aria-pressed', audio.muted?'true':'false'); }, {passive:true});
        mb.addEventListener('click', ()=>{ audio.muted=!audio.muted; mb.setAttribute('aria-pressed', audio.muted?'true':'false'); if(audio.muted) stopBGM(); else playBGM(); });
        window.addEventListener('touchstart', ()=>{ setupAudio(); resumeAudio(); }, {passive:true});
        lampOK();
      }catch(e){ lampNG(e.message||'init'); const ov=document.getElementById('resultOverlay'); ov.innerHTML='<div class="resultCard"><span class="badge lose">ãƒ‡ãƒãƒƒã‚°</span><h2>åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼</h2><p>'+e.message+'</p></div>'; ov.classList.add('show'); }
    };
    requestAnimationFrame(boot);
  }
  window.addEventListener('pageshow', ()=>{ mount(); });
  mount();
})();
</script>
</body>
</html>
