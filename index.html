<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ポ・トロクリニック あみだくじゲーム（軽量起動ビルド）</title>
<style>
  :root{
    --bg:#fff6fb;
    --pink:#ff7aa8;
    --pink-dark:#de3f7b;
    --border:#ffd6e7;
    --text:#432;
    --devil:#9b59b6;          /* デビル本体 */
    --devil-horn:#5e3370;     /* 角 */
    --ripple:rgba(0,0,0,.18);
    --ok:#2ecc71;
    --ng:#ff6262;
    --hint:#ffea00;
  }
  html,body{height:100%;}
  body{
    margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", "Noto Sans JP", "Meiryo", sans-serif;
    -webkit-tap-highlight-color: transparent;
  }
  .wrap{ max-width:880px; margin:0 auto; padding:16px env(safe-area-inset-right) 24px env(safe-area-inset-left); }
  .title{ text-align:center; font-weight:900; letter-spacing:.04em; }
  .title .heart{ display:inline-block; color:#ff3b3b; animation: heartBlink 1s infinite; }
  @keyframes heartBlink{ 0%,100%{opacity:.35} 50%{opacity:1} }

  .panel{ background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:0 6px 18px rgba(255,122,168,.15);
          padding:16px; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }

  .btn{ position:relative; appearance:none; border:1px solid var(--border); background:#fff; color:var(--text);
        padding:12px 16px; border-radius:14px; font-size:16px; font-weight:700; letter-spacing:.04em; cursor:pointer;
        transition: transform .06s ease, box-shadow .15s ease, opacity .2s; box-shadow:0 4px 10px rgba(0,0,0,.04); }
  .btn:active{ transform: scale(.98); }
  .btn[disabled]{ opacity:.4; cursor:not-allowed; }
  .btn.primary{ background:linear-gradient(180deg, #ff9cc0, #ff7aa8); color:#fff; border-color:#ff8db6; box-shadow:0 6px 16px rgba(255,122,168,.35); }
  .btn.primary:active{ transform: scale(.985); }

  .grid-entries{ display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:10px; }
  .entry{
    position:relative; background:#fff; border:2px solid #ffd9ea; border-radius:14px; padding:10px 8px; text-align:center; font-weight:800; cursor:pointer; user-select:none;
    transition: transform .06s ease, box-shadow .15s ease, border-color .2s;
  }
  .entry:active{ transform:scale(.98); }
  .entry.sel{ border-color:#ff9fc4; box-shadow:0 6px 14px rgba(255,122,168,.2); }
  .entry .tag{ position:absolute; top:6px; right:6px; background:#fff3ad; color:#6a5400; border:1px solid #ffe57f; border-radius:10px; padding:2px 6px; font-size:11px; display:none; }
  .entry.hitlike .tag{ display:inline-block; }

  .hud{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .status{ font-size:14px; opacity:.9; }

  .stage{ position:relative; margin-top:14px; background: #fff; border:1px dashed #ffd9ea; border-radius:14px; min-height:210px; display:flex; align-items:center; justify-content:center; overflow:hidden; }
  .patient{ position:absolute; bottom:18px; left:-40px; font-size:28px; opacity:0; }
  @keyframes walk{ from{ transform: translateX(0); } to{ transform: translateX(520px); } }

  .nurse, .devil, .bandaid {
    width:120px; height:120px; border-radius:18px; display:grid; place-items:center; font-size:64px; font-weight:900; letter-spacing:.02em;
  }
  .nurse{ background: #fff0f6; border:3px solid #ffc6dd; color:#ff4d91; position:absolute; transform: translateY(0) scale(1); transition: transform .4s ease, opacity .4s ease; }
  .devil{ background: var(--devil); border:3px solid #b07ad2; color:#fff; position:absolute; transform: translateY(30px) scale(.95); opacity:0; }
  .devil .horns{ position:absolute; top:-12px; width:100%; display:flex; justify-content:space-between; padding:0 24px; }
  .horn{ width:22px; height:22px; background: var(--devil-horn); clip-path: polygon(50% 0, 100% 100%, 0 100%); border-radius:2px; }
  .smoke{ position:absolute; inset:0; pointer-events:none; }
  .puff{ position:absolute; width:18px; height:18px; background:rgba(0,0,0,.06); border-radius:50%; animation: puff 700ms ease-out forwards; }
  @keyframes puff{
    from{ transform: translate(var(--x,0), var(--y,0)) scale(.6); opacity:.7; }
    to{ transform: translate(calc(var(--x,0) * 1.6), calc(var(--y,0) * 1.6)) scale(1.4); opacity:0; }
  }

  .bandaid{ background:#fff; border:3px dashed #ffb0b0; color:#ff7474; position:absolute; transform: scale(.9); opacity:0; }
  .bandaid::before, .bandaid::after{ content:""; position:absolute; width:110px; height:24px; background:#ffd6d6; border:2px solid #ff9e9e; border-radius:14px; top:48px; left:5px; }
  .bandaid::before{ transform: rotate(45deg); }
  .bandaid::after{ transform: rotate(-45deg); }

  .result{ margin-top:12px; text-align:center; font-weight:900; letter-spacing:.06em; }
  .result.ok{ color:var(--ok); }
  .result.ng{ color:var(--ng); }

  /* リップル */
  .ripple{
    position:absolute; border-radius:50%; transform: scale(0); opacity:.55; background:var(--ripple); animation: ripple .5s ease-out forwards; pointer-events:none;
  }
  @keyframes ripple{ to{ transform: scale(8); opacity:0; } }

  /* ハート紙吹雪（軽量版） */
  .confetti{ pointer-events:none; position:absolute; inset:0; overflow:hidden; }
  .confetti span{ position:absolute; top:-10px; font-size:18px; animation: fall linear forwards; }
  @keyframes fall{ to{ transform: translateY(120%); opacity:0.8 } }

  .foot{ margin-top:14px; font-size:12px; opacity:.7; text-align:center; }
</style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">ポ・トロクリニック <span style="font-weight:700">あみだくじゲーム</span> <span class="heart">♡</span></h1>

    <div class="panel" id="app">
      <div class="hud">
        <div class="status" id="status">入口をえらんでください（診察1〜5）</div>
        <button class="btn primary" id="startBtn" disabled>診察開始<span aria-hidden="true">♡</span></button>
      </div>

      <div class="grid-entries" id="entries"></div>

      <div class="stage" id="stage" aria-live="polite" aria-atomic="true">
        <div class="patient" id="patient" title="患者">🤒</div>
        <div class="nurse" id="nurse" title="ナース">🩺</div>
        <div class="devil" id="devil" title="デビル">
          <div class="horns"><div class="horn"></div><div class="horn"></div></div>
          😈
          <div class="smoke" id="smoke"></div>
        </div>
        <div class="bandaid" id="bandaid" title="バンドエイド"></div>
        <div class="confetti" id="confetti"></div>
      </div>

      <div class="result" id="result">　</div>
    </div>

    <div class="foot">B案ロジック：見た目の当たりは毎回1本／最終判定で1/3→真当たり（体験確率≈1/15）・iPhone/Safariオーディオは最初のタップで解錠</div>
  </div>

<script>
(() => {
  const q = sel => document.querySelector(sel);
  const ce = (tag, cls) => { const el=document.createElement(tag); if(cls) el.className=cls; return el; };

  // ===== 軽量起動：初回操作まで重い初期化を遅延 =====
  let audioReady = false, ctx, sfxGain, bgmGain, bgmTimer = null;
  function unlockAudio(){
    if(audioReady) return;
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      ctx = new AudioCtx();
      sfxGain = ctx.createGain();
      sfxGain.gain.value = 0.15; // SFXは従来どおり
      sfxGain.connect(ctx.destination);
      bgmGain = ctx.createGain();
      bgmGain.gain.value = 0.28; // ★BGMの元音量をアップ
      bgmGain.connect(ctx.destination);
      startBGM();
      audioReady = true;
    }catch(e){ console.warn('Audio init failed', e); }
  }
  function beep({freq=880, dur=0.12, type='sine', when=0}){
    if(!audioReady) return;
    const t = ctx.currentTime + when;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = type; o.frequency.value = freq;
    o.connect(g); g.connect(sfxGain);
    g.gain.setValueAtTime(0, t);
    g.gain.linearRampToValueAtTime(1, t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
    o.start(t); o.stop(t+dur);
  }
  const sfx = {
    whoosh(){ [420,360,300].forEach((f,i)=>beep({freq:f, dur:0.08, type:'sawtooth', when:i*0.04})); },
    fanfare(){ [660,880,990].forEach((f,i)=>beep({freq:f, dur:.15, type:'triangle', when:i*0.12})); },
    thud(){ beep({freq:160, dur:.1, type:'square'}); beep({freq:100, dur:.12, type:'square', when:.08}); }
  };

  // ===== BGM（軽量なループ） =====
  function startBGM(){
    if(!audioReady || bgmTimer) return;
    const tone = (freq=440, dur=0.2, when=0) => {
      const t = ctx.currentTime + when;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine'; o.frequency.value = freq;
      o.connect(g); g.connect(bgmGain);
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(1, t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
      o.start(t); o.stop(t+dur);
    };
    const pattern = [523, 659, 587, 698];
    let idx = 0;
    bgmTimer = setInterval(()=>{
      tone(pattern[idx % pattern.length], 0.28);
      idx++;
    }, 520);
  }

  // ===== UI要素 =====
  const entriesEl = q('#entries');
  const startBtn = q('#startBtn');
  const status = q('#status');
  const result = q('#result');
  const nurse = q('#nurse');
  const devil = q('#devil');
  const bandaid = q('#bandaid');
  const smoke = q('#smoke');
  const confetti = q('#confetti');
  const patient = q('#patient');
  const patient = q('#patient');

  // 診察エントリ生成（5本）
  const N = 5;
  let selected = -1;
  let running = false;
  let round = 0;

  const entries = [...Array(N)].map((_,i)=>{
    const btn = ce('button', 'entry btnlike');
    btn.setAttribute('data-i', i);
    btn.setAttribute('aria-pressed','false');
    btn.innerHTML = `診察${i+1}<span class="tag">当たり!?</span>`;
    addRippleHandler(btn);
    btn.addEventListener('click', () => {
      unlockAudio();
      if(running) return;
      select(i);
    });
    return btn;
  });
  entries.forEach(b=>entriesEl.appendChild(b));

  function select(i){
    entries.forEach(b=>b.classList.remove('sel'));
    entries[i].classList.add('sel');
    selected = i;
    startBtn.disabled = false;
    status.textContent = `選択中：診察${i+1}（見た目の当たりは毎回1本）`;
  }

  // ラウンド開始
  startBtn.addEventListener('click', () => {
    unlockAudio();
    if(selected===-1 || running) return;
    running = true;
    startBtn.disabled = true; // 結果が出るまで無効化
    result.textContent = '診察中…';
    result.className = 'result';

    round++;

    // 見た目の当たりを1本マーク
    entries.forEach(b=>b.classList.remove('hitlike'));
    const apparent = Math.floor(Math.random()*N);
    entries[apparent].classList.add('hitlike');

    // ステージ初期状態
    resetStage();

    // ちょっと演出（0.9秒）
    patient.style.opacity = 1;
    patient.style.animation = 'none'; patient.offsetWidth; // reflow
    patient.style.animation = 'walk var(--walkDur,0.6s) linear forwards';

    setTimeout(()=>{
      if(selected === apparent){
        const win = Math.random() < (1/3);
        if(win){ showWin(); } else { showFake(); }
      }else{ showLose(); }
    }, 600);
  });

  function resetStage(){
    nurse.style.opacity = 1; nurse.style.transform = 'translateY(0) scale(1)';
    devil.style.opacity = 0; devil.style.transform = 'translateY(30px) scale(.95)';
    bandaid.style.opacity = 0; bandaid.style.transform = 'scale(.9)';
    smoke.innerHTML = '';
    confetti.innerHTML = '';
    if(patient){ patient.style.opacity = 0; patient.style.animation = 'none'; }
  }

  function showFake(){
    // ナース → デビル（紫）変身＋煙
    sfx.whoosh();
    nurse.style.opacity = .0; nurse.style.transform = 'translateY(-18px) scale(.9)';
    devil.style.opacity = 1; devil.style.transform = 'translateY(0) scale(1)';
    // 煙パーティクル
    for(let i=0;i<24;i++){
      const p = ce('div','puff');
      const a = (Math.random()*Math.PI*2);
      const r = 40 + Math.random()*70;
      p.style.setProperty('--x', Math.cos(a)*r+'px');
      p.style.setProperty('--y', Math.sin(a)*r+'px');
      p.style.left = (60 + Math.random()*20)+'px';
      p.style.top  = (40 + Math.random()*40)+'px';
      smoke.appendChild(p);
    }
    result.textContent = '偽当たり… デビルに変身！';
    result.className = 'result ng';
    finishAfter(1100);
  }

  function showLose(){
    sfx.thud();
    bandaid.style.opacity = 1; bandaid.style.transform = 'scale(1)';
    result.textContent = 'ハズレ… バンドエイドのクロス';
    result.className = 'result ng';
    finishAfter(900);
  }

  function showWin(){
    sfx.fanfare();
    nurse.style.transform = 'translateY(-6px) scale(1.04)';
    // 軽量ハート紙吹雪
    for(let i=0;i<24;i++){
      const sp = ce('span');
      sp.textContent = '❤';
      sp.style.left = Math.random()*100+'%';
      sp.style.animationDuration = (1.4 + Math.random()*0.8)+'s';
      confetti.appendChild(sp);
    }
    result.textContent = '真当たり！おめでとう♡';
    result.className = 'result ok';
    finishAfter(1500);
  }

  function finishAfter(ms){
    setTimeout(()=>{
      running = false;
      startBtn.disabled = (selected === -1); // 次の挑戦OK
      status.textContent = `もう一度挑戦できます（現在の選択：診察${selected+1}）`;
    }, ms);
  }

  // リップル＋縮み（btn/entry 共通）
  function addRippleHandler(el){
    el.classList.add('btn');
    el.addEventListener('pointerdown', (ev)=>{
      const r = ce('span');
      r.className='ripple';
      const rect = el.getBoundingClientRect();
      const x = ev.clientX - rect.left; const y = ev.clientY - rect.top;
      const d = Math.max(rect.width, rect.height);
      r.style.width=r.style.height=d+'px';
      r.style.left=(x - d/2)+'px';
      r.style.top=(y - d/2)+'px';
      el.appendChild(r);
      setTimeout(()=>r.remove(), 520);
    });
  }

  // スタートにもリップル
  addRippleHandler(startBtn);

  // 初期メッセージ
  status.textContent = '入口をえらんでください（診察1〜5）';
})();
</script>
</body>
</html>
